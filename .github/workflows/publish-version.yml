name: Publish Version

on:
  workflow_dispatch:
    inputs:
      platforms:
        description: "Target platforms"
        required: true
        default: "linux/amd64"
      version:
        description: "Override version (x.y.z or x.y.z.bb)"
        required: false
        default: ""

permissions:
  contents: write

env:
  IMAGE_NAME: espressomatic/lm-bridge
  DEPLOY_REPO: ${{ github.repository_owner }}/LM-Bridge

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Generate media format mappings
        run: |
          python3 scripts/generate-media-formats.py

      - name: Bump patch + sync version files
        id: bump
        run: |
          set -e
          if [ ! -f VERSION ]; then
            echo "VERSION file not found." >&2
            exit 1
          fi

          export INPUT_VERSION="${{ inputs.version }}"
          PY_OUTPUT=$(python3 - <<'PY'
          import re
          import os
          from pathlib import Path

          version_path = Path("VERSION")
          version_input = os.environ.get("INPUT_VERSION", "").strip()

          def _clean(raw: str) -> str:
              raw = raw.replace("\\n", "").strip()
              if raw.startswith("v"):
                  raw = raw[1:]
              return raw

          def _release_version(version: str) -> str:
              m = re.fullmatch(r"(\\d+\\.\\d+\\.\\d+)\\.(\\d{1,3})", version)
              if m and int(m.group(2)) == 0:
                  return m.group(1)
              return version

          def _docker_version(version: str) -> str:
              m = re.fullmatch(r"(\\d+\\.\\d+\\.\\d+)\\.(\\d{1,3})", version)
              if m:
                  return m.group(1)
              m = re.fullmatch(r"(\\d+\\.\\d+\\.\\d+)", version)
              if m:
                  return m.group(1)
              raise SystemExit(f"Invalid version for Docker tag: {version!r}")

          if version_input:
              version_input = _clean(version_input)
              if re.fullmatch(r"\\d+\\.\\d+\\.\\d+", version_input):
                  new_version = version_input
              else:
                  m = re.fullmatch(r"\\d+\\.\\d+\\.\\d+\\.\\d{1,3}", version_input)
                  if not m:
                      raise SystemExit(f"Invalid version override: {version_input!r}")
                  new_version = version_input
          else:
              version = _clean(version_path.read_text())
              m3 = re.fullmatch(r"(\\d+)\\.(\\d+)\\.(\\d+)", version)
              m4 = re.fullmatch(r"(\\d+)\\.(\\d+)\\.(\\d+)\\.(\\d{1,3})", version)
              if not m3 and not m4:
                  raise SystemExit(f"VERSION format invalid: {version!r}")
              if m3:
                  major, minor, patch = map(int, m3.groups())
                  patch += 1
                  new_version = f"{major}.{minor}.{patch}"
              else:
                  major, minor, patch, _build = map(int, m4.groups())
                  patch += 1
                  new_version = f"{major}.{minor}.{patch}.00"

          version_path.write_text(new_version + "\n")
          Path("deploy/VERSION").write_text(new_version + "\n")

          csproj_path = Path("lm-bridge-plugin/plugin/LMBridgePlugin.csproj")
          text = csproj_path.read_text()
          text, count1 = re.subn(r"<AssemblyVersion>[^<]+</AssemblyVersion>",
                                 f"<AssemblyVersion>{new_version}</AssemblyVersion>", text, count=1)
          text, count2 = re.subn(r"<Version>[^<]+</Version>",
                                 f"<Version>{new_version}</Version>", text, count=1)
          if count1 != 1 or count2 != 1:
            raise SystemExit("Failed to update LMBridgePlugin.csproj version fields.")
          csproj_path.write_text(text)

          readme_path = Path("deploy/README.md")
          if readme_path.exists():
            readme_text = readme_path.read_text()
            readme_text, count = re.subn(r"Deploy version: `[^`]+`",
                                         f"Deploy version: `{new_version}`", readme_text, count=1)
            if count == 1:
              readme_path.write_text(readme_text)

          release_version = _release_version(new_version)
          docker_version = _docker_version(new_version)
          print(new_version)
          print(release_version)
          print(docker_version)
          PY
          )

          NEW_VERSION=$(echo "$PY_OUTPUT" | sed -n '1p')
          RELEASE_VERSION=$(echo "$PY_OUTPUT" | sed -n '2p')
          DOCKER_VERSION=$(echo "$PY_OUTPUT" | sed -n '3p')

          echo "new_version=$NEW_VERSION" >> "$GITHUB_OUTPUT"
          echo "release_version=$RELEASE_VERSION" >> "$GITHUB_OUTPUT"
          echo "docker_version=$DOCKER_VERSION" >> "$GITHUB_OUTPUT"

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add VERSION deploy/VERSION deploy/README.md lm-bridge-plugin/plugin/LMBridgePlugin.csproj \
            overlay/bridge/lidarrmetadata/media_formats_meta.py \
            lm-bridge-plugin/plugin/Metadata/MetadataSourceOverride/MediaFormats.generated.cs
          if git diff --cached --quiet; then
            echo "No version change to commit."
          else
            NEW_VERSION="${{ steps.bump.outputs.new_version }}"
            git commit -m "Publish version ${NEW_VERSION}"
            git push
          fi

      - name: Tag release
        run: |
          VERSION="${{ steps.bump.outputs.release_version }}"
          TAG="v${VERSION}"
          git fetch --tags
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "Tag $TAG already exists."
            exit 0
          fi
          git tag -a "$TAG" -m "Version $VERSION"
          git push origin "$TAG"

      - name: Set up .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Build plugin ZIP
        run: |
          chmod +x lm-bridge-plugin/build.sh
          VERSION_OVERRIDE="${{ steps.bump.outputs.new_version }}" lm-bridge-plugin/build.sh

      - name: Normalize plugin ZIP filename
        run: |
          NEW_VERSION="${{ steps.bump.outputs.new_version }}"
          RELEASE_VERSION="${{ steps.bump.outputs.release_version }}"
          if [[ "$NEW_VERSION" != "$RELEASE_VERSION" ]]; then
            src="lm-bridge-plugin/dist/LMBridge_Plugin-${NEW_VERSION}-net8.0.zip"
            dst="lm-bridge-plugin/dist/LMBridge_Plugin-${RELEASE_VERSION}-net8.0.zip"
            if [[ -f "$src" ]]; then
              mv "$src" "$dst"
            else
              echo "Plugin ZIP not found: $src" >&2
              exit 1
            fi
          fi

      - name: Publish plugin to deploy repo release
        env:
          GH_TOKEN: ${{ secrets.LMBRIDGE_DEPLOY_TOKEN }}
          TAG: v${{ steps.bump.outputs.release_version }}
          VERSION: ${{ steps.bump.outputs.release_version }}
        run: |
          set -euo pipefail
          if [[ -z "${GH_TOKEN:-}" ]]; then
            echo "LMBRIDGE_DEPLOY_TOKEN not set; skipping deploy repo release."
            exit 0
          fi
          files=(lm-bridge-plugin/dist/*.zip)
          title="LM-Bridge Plugin v${VERSION}"
          if gh release view "${TAG}" --repo "${DEPLOY_REPO}" >/dev/null 2>&1; then
            gh release upload "${TAG}" "${files[@]}" --repo "${DEPLOY_REPO}" --clobber
          else
            gh release create "${TAG}" "${files[@]}" --repo "${DEPLOY_REPO}" --title "${title}" --generate-notes
          fi

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN_LMBRIDGE }}

      - name: Compute Docker tags
        id: docker-tags
        shell: bash
        run: |
          version="${{ steps.bump.outputs.docker_version }}"
          if [[ "$version" =~ ^([0-9]+\.[0-9]+\.[0-9]+)$ ]]; then
            docker_tag="${BASH_REMATCH[1]}"
          else
            echo "Invalid version for Docker Hub tag: $version" >&2
            exit 1
          fi
          echo "docker_tag=$docker_tag" >> "$GITHUB_OUTPUT"

      - name: Build and push image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile
          build-args: |
            APP_VERSION=${{ steps.docker-tags.outputs.docker_tag }}
          platforms: ${{ inputs.platforms }}
          push: true
          tags: |
            ${{ env.IMAGE_NAME }}:${{ steps.docker-tags.outputs.docker_tag }}
            ${{ env.IMAGE_NAME }}:latest
          labels: |
            org.opencontainers.image.title=LM-Bridge
            org.opencontainers.image.source=https://github.com/${{ github.repository }}
            org.opencontainers.image.url=https://github.com/${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.version=${{ steps.docker-tags.outputs.docker_tag }}

      - name: Update Docker Hub description
        uses: peter-evans/dockerhub-description@v4
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN_LMBRIDGE }}
          repository: espressomatic/lm-bridge
          readme-filepath: DOCKERHUB_DESCRIPTION.md

      - name: Checkout deploy repo
        uses: actions/checkout@v4
        with:
          repository: ${{ env.DEPLOY_REPO }}
          token: ${{ secrets.LMBRIDGE_DEPLOY_TOKEN }}
          path: deploy-repo

      - name: Sync deploy folder
        run: |
          chmod +x scripts/export-deploy.sh
          DEPLOY_REPO=deploy-repo DEPLOY_DELETE=1 scripts/export-deploy.sh

      - name: Commit and push deploy repo
        run: |
          if [[ -z "$(git -C deploy-repo status --porcelain)" ]]; then
            echo "No changes to deploy repo."
            exit 0
          fi
          git -C deploy-repo config user.name "github-actions[bot]"
          git -C deploy-repo config user.email "github-actions[bot]@users.noreply.github.com"
          git -C deploy-repo add .
          sync_sha="$(git rev-parse HEAD)"
          git -C deploy-repo commit -m "Sync deploy from ${GITHUB_REPOSITORY}@${sync_sha}"
          git -C deploy-repo push
